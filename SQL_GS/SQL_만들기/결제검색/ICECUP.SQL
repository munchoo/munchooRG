SELECT    A.STK_EVAL_DT AS 수불일자
--     ,    A.GOODS_CD AS 상품코드
--     ,    B.GOODNM AS 상품명
     ,    SUM(CASE WHEN A.BUY_SP IN ('B1','B6','B8') THEN A.STKIN_QTY ELSE 0 END)      AS 출하수량                 /* 점포 센터 매입, 출하수량      */
     ,    SUM(CASE WHEN A.BUY_SP = 'B9' THEN A.STKIN_QTY ELSE 0 END)                   AS 단품이동수량              /* 단품이동수량                  */
     ,    SUM(CASE WHEN A.BUY_SP = 'B2' THEN A.STKIN_QTY ELSE 0 END * (-1))            AS 출하반품수량                 /* 점포 거래처,센터반품 수량     */

     ,    SUM(CASE WHEN A.BUY_SP IN ('B1','B6','B8') THEN A.STKIN_QTY ELSE 0 END) -
          SUM(CASE WHEN A.BUY_SP = 'B9' THEN A.STKIN_QTY ELSE 0 END) -
          SUM(CASE WHEN A.BUY_SP = 'B2' THEN A.STKIN_QTY ELSE 0 END * (-1))            AS 출하반품수량                 /* 점포 거래처,센터반품 수량     */
  FROM    LGMJVDP.TS_BY_BUY_BASE A
  JOIN    LGMJVDP.TB_GOOD_DM B
    ON    A.GOODS_CD = B.GOODCD
  JOIN    LGMJVDP.TB_STORE_DM C
    ON    A.BIZPL_CD = 'V'||SUBSTR(C.STORENM,INSTR(C.STORENM,'(')+1, -( INSTR(C.STORENM,'(') -INSTR(C.STORENM,':'))-1)
 WHERE    (A.STK_EVAL_DT BETWEEN '20210301' AND '20210430' OR A.STK_EVAL_DT BETWEEN '20220401' AND '20220430')
   AND    A.BIZPL_CD = 'V1904'
   AND    A.CENTER_VNDR_SP <> '3'
   AND    A.GOODS_CD in ('8801308448578','8801308448585','8801308449384')
   AND    A.STKIN_QTY <> 0
 GROUP BY A.STK_EVAL_DT
--     ,    A.GOODS_CD
--     ,    B.GOODNM
 ORDER BY 1,2

select  a1.STORECD,
        a1.DATECD,
        sum(a1.PREV_QTY + a1.IN_QTY - STK_QTY) as hi
from   LGMJVDP.TB_STK_FT a1
    JOIN LGMJVDP.TB_STORE_DM b1
    ON a1.STORECD = b1.STORECD
where a1.STORECD in ('S355')
and a1.DATECD BETWEEN ('2022-04-01') AND ('2022-04-25')
and a1.GOODCD in ('8801308448578','8801308448585','8801308449384')
group by a1.STORECD, a1.DATECD



--------------------

---- IQR를 활용한 특이점 제거하는 쿼리입니다. 
---- heaer에 해당기간 얼음컵 판매수량을 가져옵니다. 
---- 이월재고 + 입고수량 - 기말재고 를 통해 판매수량을 산정한 식을 사용합니다. 
---- IqrTB 에는 header에서 가져온 데이터를 통해 사분위수를 산정합니다. 
---- 두테이블을 점포코드로 조인 후 특이값을 제거하는 공식을 사용합니다. 
---- 3분위 + iqr * 1.5를 특이점  조건을 걸어서 이상값을 제거 한 후 Max를 통해
---- 최대값을 산정합니다. 

TRUNC(SYSDATE, 'MM') and to_char(sysdate-2, 'YYYY-MM-DD')

TRUNC(Add_Years(sysdate,-1),'MM')  LAST_DAY(Add_Years(sysdate,-1),'MM')

WITH header as(
        select  a1.STORECD,
                a1.DATECD,
                sum(a1.PREV_QTY + a1.IN_QTY - STK_QTY) as hi
        from   LGMJVDP.TB_STK_FT a1
            JOIN LGMJVDP.TB_STORE_DM b1
            ON a1.STORECD = b1.STORECD
        where b1.RGNCD in ('54')
        and a1.DATECD BETWEEN TRUNC(Add_Years(sysdate,-1),'MM') AND LAST_DAY(Add_Years(sysdate,-1),'MM')
        and a1.GOODCD in ('8801308448578','8801308448585','8801308449384')
        group by a1.STORECD, a1.DATECD
), IqrTB AS (
    SELECT STORECD
        ,PERCENTILE_DISC(0.25) WITHIN GROUP (ORDER BY hi) AS q1 
        ,PERCENTILE_DISC(0.75) WITHIN GROUP (ORDER BY hi) AS q3
        ,PERCENTILE_DISC(0.75) WITHIN GROUP (ORDER BY hi) 
        - PERCENTILE_DISC(0.25) WITHIN GROUP (ORDER BY hi) AS iqr
    FROM header
    GROUP BY STORECD)
---------------- 스캔 후 조인
SELECT r.STORECD, max(hi) AS MaxSale, s.q3, s.iqr
FROM  header AS r 
LEFT JOIN IqrTB AS s 
ON r.STORECD = s.STORECD
WHERE r.hi < (s.q3 + 1.5 * s.iqr)
GROUP BY r.STORECD, s.q3, s.iqr








---------------- 이상치 제거

WITH stats AS (
    SELECT region 
        ,PERCENTILE_DISC(0.25) WITHIN GROUP (ORDER BY amt) AS q1 
        ,PERCENTILE_DISC(0.75) WITHIN GROUP (ORDER BY amt) AS q3
        ,PERCENTILE_DISC(0.75) WITHIN GROUP (ORDER BY amt) 
        - PERCENTILE_DISC(0.25) WITHIN GROUP (ORDER BY amt) AS iqr
    FROM reg_sales
    GROUP BY region )
SELECT r.* 
FROM reg_sales AS r 
LEFT JOIN stats AS s 
ON r.region = s.region 
WHERE r.amt > (s.q1 - 1.5 * s.iqr) 
AND r.amt < (s.q3 + 1.5 * s.iqr)






-----------------------판매수량

select	a11.STORECD  STORECD,
	max(SUBSTR(a12.STORENM,1,INSTR(a12.STORENM,'(')-1 ))  STORENM,
	max('V'||SUBSTR(a12.STORENM,INSTR(a12.STORENM,'(')+1, -( INSTR(a12.STORENM,'(') -INSTR(a12.STORENM,':'))-1))  CustCol_31,
	sum(a11.SAL_QTY)  WJXBFS1
from	LGMJVDP.TB_STK_FT	a11
	join	LGMJVDP.TB_STORE_DM	a12
	  on 	(a11.STORECD = a12.STORECD)
where	(a11.GOODCD in ('2800014510865', '2800014510704', '2800100153051', '2800100099267', '2800014510780', '2800100153044', '2800100099298', '2800100008030', '2800100038464', '2800014510919', '2800100099304', '2800100044762', '2800100043062', '2800100039782', '2800100150111', '2800100038020', '2800014510124', '2800100036224', '2800014211571', '2800100153075', '8808024030117', '8808024030131', '8805584224192', '2800014510902', '8808024028299', '8808024026882', '2800100153082', '2800014510940', '2800014211694', '2800014211267', '8809695310362', '2800100153068', '2800014510292', '8801037001914', '2800014510896', '2800100131189', '2800014510285', '2800100153099', '2800100153112', '2800100131134', '2800100008993', '2800100153105', '2800100131172', '2800014510810', '2800014510797', '2800014510803', '2800100109911', '2800014510742', '2800100109904', '2800014211595', '2800014211649', '2800014510131', '2800100075261', '2800014510711', '2800047510047', '2800100011412', '2800014211670', '2800100040108', '8801746502900', '2800014510148', '2800100108600', '2800014510308', '2800014510834', '2800014510513', '2800014510155', '2800014510353', '2800014211656', '2800014211687', '2800014211281', '2800014510728', '2800014510766', '2800014211601', '2800047510085', '2800100156199', '2800014210871', '2800022300762', '2800014510162', '2800014510759', '2800014510841', '2800014510858', '2800022300533', '2800041210677', '2800099980102', '2800100011108', '8801308449384', '8801308448585', '8801308448578', '8801308450960', '8809592640333')
 and a11.DATECD in ('2022-04-27')
 and a12.RGNCD in ('54'))
group by	a11.STORECD




with	 gopa1 as
 (select	a11.STORECD  STORECD,
			a11.DATECD  DATECD,
			sum(a11.IN_QTY)  WJXBFS1,
			sum(a11.SAL_QTY)  WJXBFS2
		from	LGMJVDP.TB_STK_FT	a11
			join	LGMJVDP.TB_DATE_DM	a12
			  on 	(a11.DATECD = a12.DATECD)
			join	LGMJVDP.TB_STORE_DM	a13
			  on 	(a11.STORECD = a13.STORECD)
		where	(a11.GOODCD in ('8801308449384', '8801308448585', '8801308448578', '8801308450960', '8809592640333')
		 and a13.RGNCD in ('54')
		 and a12.YMCD in ('202204'))
		group by	a11.STORECD,
			a11.DATECD
		), 
	 gopa2 as
 (select	a11.STORECD  STORECD,
			a12.DATECD  DATECD,
			sum(a11.stk_qty)  WJXBFS1
		from	LGMJVDP.TB_STK_FT	a11
			join	LGMJVDP.TB_DATE_DM	a12
			  on 	(a11.DATECD = a12.DATECD  -1 day)
			join	LGMJVDP.TB_STORE_DM	a13
			  on 	(a11.STORECD = a13.STORECD)
		where	(a11.GOODCD in ('8801308449384', '8801308448585', '8801308448578', '8801308450960', '8809592640333')
		 and a13.RGNCD in ('54')
		 and a12.YMCD in ('202204'))
		group by	a11.STORECD,
			a12.DATECD
		), 
	 gopa3 as
 (select	coalesce(pa11.STORECD, pa12.STORECD)  STORECD,
		coalesce(pa11.DATECD, pa12.DATECD)  DATECD,
		sum(((VALUE(pa11.WJXBFS1, 0) + VALUE(pa12.WJXBFS1, 0)) - VALUE(pa11.WJXBFS2, 0)))  WJXBFS1
	from	gopa1	pa11
		full outer join	gopa2	pa12
		  on 	(pa11.DATECD = pa12.DATECD and 
		pa11.STORECD = pa12.STORECD)
		join	LGMJVDP.TB_DATE_DM	a13
		  on 	(coalesce(pa11.DATECD, pa12.DATECD) = a13.DATECD)
		join	LGMJVDP.TB_STORE_DM	a14
		  on 	(coalesce(pa11.STORECD, pa12.STORECD) = a14.STORECD)
	where	(a14.RGNCD in ('54')
	 and a13.YMCD in ('202204'))
	group by	coalesce(pa11.STORECD, pa12.STORECD),
		coalesce(pa11.DATECD, pa12.DATECD)
	), 
	 gopa4 as
 (select	pc11.STORECD  STORECD,
		max(pc11.DATECD)  WJXBFS1
	from	gopa3	pc11
	group by	pc11.STORECD
	)
select	distinct pa11.STORECD  STORECD,
	SUBSTR(a13.STORENM,1,INSTR(a13.STORENM,'(')-1 )  STORENM,
	'V'||SUBSTR(a13.STORENM,INSTR(a13.STORENM,'(')+1, -( INSTR(a13.STORENM,'(') -INSTR(a13.STORENM,':'))-1)  CustCol_31,
	pa11.WJXBFS1  WJXBFS1
from	gopa3	pa11
	join	gopa4	pa12
	  on 	(pa11.DATECD = pa12.WJXBFS1 and 
	pa11.STORECD = pa12.STORECD)
	join	LGMJVDP.TB_STORE_DM	a13
	  on 	(pa11.STORECD = a13.STORECD)

