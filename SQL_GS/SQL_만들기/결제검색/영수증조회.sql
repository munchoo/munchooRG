WITH HEADER AS (
SELECT    A.OPER_DT
     ,    A.ORIGIN_BIZPL_CD
     ,    A.POS_NO
     ,    A.SALE_SEQ
     ,    A.POS_NO || A.RECEIPT_NO  AS RECEIPT_NO
     ,    A.DEAL_SP
     ,    A.TOT_AMT
     ,    A.TOT_QTY
     ,    TO_CHAR(A.SALE_END_DTTM, 'HH24') AS TIME_CD
     ,    A.SALE_END_DTTM
  FROM    GSSCODS.TS_TR_HEADER A
 WHERE    A.OPER_DT BETWEEN REPLACE('2024-04-26','-','') AND REPLACE('2024-04-29','-','')
   AND    A.DEAL_SP IN ('01','33')  --정상판매 , 기프트콘
   and A.ORIGIN_BIZPL_CD in ('V8U47')
  
)
,
ITEM AS  (
SELECT    A.OPER_DT
     ,    C.RGN_GRPNM
     ,    C.RGNNM
     ,    C.TEAM_LN
     ,    C.PART_LN
     ,    A.ORIGIN_BIZPL_CD
     ,    C.STORECD
     ,    C.STORENM
     ,    A.POS_NO
     ,    A.SALE_SEQ
     ,    B.GOOD_CLS1NM  --중분류명
     ,    B.GOOD_CLS2NM  --소분류명
     ,    A.GOODS_CD
     ,    B.GOODNM
     ,    SUM(A.DC_PRC)      AS DC_PRC       --매가
     ,    SUM(A.MBR_DC_AMT)  AS MBR_DC_AMT   --멤버십할인금액
     ,    SUM(A.PRMT_DC_AMT) AS PRMT_DC_AMT  --판촉할인금액
     ,    SUM(A.SALE_QTY)    AS SALE_QTY     --판매수량
     ,    SUM(( A.DC_PRC * A.SALE_QTY ) - A.MBR_DC_AMT - A.PRMT_DC_AMT)  AS SALE_AMT
  FROM    GSSCODS.TS_TR_ITEM A
  LEFT    OUTER JOIN    LGMJVDP.TB_GOOD_DM B
    ON    A.GOODS_CD = B.GOODCD
  JOIN    LGMJVDP.TB_STORE_DM  C
    ON    SUBSTR(A.ORIGIN_BIZPL_CD,2,4) = C.STORECD

 WHERE    A.OPER_DT BETWEEN REPLACE('2024-04-26','-','') AND REPLACE('2024-04-29','-','')
   -- AND    B.GOODCD in ('8809443710345', '8805684005684', '8801007112480', '8801007112497', '8801007348308', '8801123311064', '8809759470315', '8809448350478', '8801073010208', '8801077464700', '8801077447406', '8801123727759', '8801123727742', '2800100209451', '8801068406832', '8809069307875', '2345001724073', '2345001709186', '2345001828900', '2800045105979', '2345001845051', '2800100212529', '8804989202156', '8809317722146', '8801056177553', '8801056226459', '8801056839017', '8850999016863', '8850999018508', '8801382127710', '030900010991', '8801155722647', '8801155722630', '8801155742164', '8801104500623', '8801104500647', '8801104663786', '8801104674829', '8809490180818', '8809490180795', '3175520018716', '8003360420756', '4902335060222', '5010038486269', '5010038486931', '4002103312000', '4002103311959', '8801007880280', '8801007760292', '8801007289649', '8809778492534', '8801045082318', '8809778493005', '8809778493012', '8801073112278', '8850157401104', '8850157405737', '8850157402064', '8801007761503', '8801007761527', '8801007761541', '8801019314001', '8801062870301', '8809311490430', '8809311490423', '8809311492311', '8809311490942', '8809113623005', '8809113628031', '8809004770566', '8809175300333', '8809175300326', '8809709260126', '8809709260140', '8801260603831', '8809267017170', '8809267016982')
   AND    A.SALE_SP IN ('1', '2')  --장상판매 , 고객반품
   AND    A.SKU_CANCEL_YN   =  'N'
   and A.ORIGIN_BIZPL_CD in ('V8U47')
  
 GROUP BY A.OPER_DT
     ,    C.RGN_GRPNM
     ,    C.RGNNM
     ,    C.TEAM_LN
     ,    C.PART_LN
     ,    A.ORIGIN_BIZPL_CD
     ,    C.STORECD
     ,    C.STORENM
     ,    A.POS_NO
     ,    A.SALE_SEQ
     ,    B.GOOD_CLS1NM
     ,    B.GOOD_CLS2NM
     ,    A.GOODS_CD
     ,    B.GOODNM
)

SELECT    A.RGN_GRPNM  AS 부문명
     ,    A.RGNNM      AS 지역명
     ,    B.SALE_SEQ    AS 판매순서
     ,    B.RECEIPT_NO   AS 영수증번호
     ,    B.TIME_CD   AS 시간
     ,    A.OPER_DT     AS 일시
     ,    A.TEAM_LN    AS 팀명
     ,    A.PART_LN    AS OFC명
     ,    A.ORIGIN_BIZPL_CD AS 최초점포코드
     ,    A.STORECD    AS 점포코드
     ,    A.STORENM    AS 점포명
     ,    A.GOOD_CLS1NM  AS 중분류명
     ,    A.GOOD_CLS2NM  AS 소분류명
     ,    A.GOODS_CD     AS 상품코드
     ,    A.GOODNM       AS 상품명
     ,    MAX(A.DC_PRC)      AS 매가
     ,    SUM(A.MBR_DC_AMT)  AS 멤버십할인금액
     ,    SUM(A.PRMT_DC_AMT) AS 판촉할인금액
     ,    SUM(A.SALE_QTY)    AS 판매수량
     ,    SUM(A.SALE_AMT)    AS 매출액
  FROM    ITEM  A
  JOIN    HEADER B
    ON    A.OPER_DT = B.OPER_DT
   AND    A.ORIGIN_BIZPL_CD   = B.ORIGIN_BIZPL_CD
   AND    A.POS_NO = B.POS_NO
   AND    A.SALE_SEQ = B.SALE_SEQ

 GROUP BY A.RGN_GRPNM
     ,    A.RGNNM
     ,    B.SALE_SEQ
     ,    B.RECEIPT_NO
     ,    B.TIME_CD
     ,    A.OPER_DT
     ,    A.TEAM_LN
     ,    A.PART_LN
     ,    A.ORIGIN_BIZPL_CD
     ,    A.STORECD
     ,    A.STORENM
     ,    A.GOOD_CLS1NM
     ,    A.GOOD_CLS2NM
     ,    A.GOODS_CD
     ,    A.GOODNM


