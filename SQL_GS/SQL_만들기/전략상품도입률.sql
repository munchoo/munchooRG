-- 대상상품 추출
-- UserProd 는 전월 말일 7일전 부터 재고가 0개 이상인 것에 대한 취급여부 판단.
-- ShortageProd 는 해당기간의 취급 상품을 전체 표시 (당월)
-- with문으로 조회 후 inner 조인으로 UserProd와 ShortageProd를 묶음.(대상상품만 추출하기위해)
-- 영업일수를 가져와서 조인하고 마지막에 취급률을 계산 (누적결품상품수 / (결품대상상품수 * 영업일수)*100)
WITH UseProd AS (
    select	a11.STORECD  STORECD,
        a11.GOODCD  GOODCD,
        max(trim(trailing from a13.GOODNM))  GOODNM,
        sum( case when a11.stk_qty > 0 then 1
            else 0 END) AS 취급
    from	LGMJVDP.TB_STK_FT	a11
        join	LGMJVDP.TB_STORE_DM	a12
        on 	(a11.STORECD = a12.STORECD)
        join	LGMJVDP.TB_GOOD_DM	a13
        on 	(a11.GOODCD = a13.GOODCD)
    where	(a11.DATECD between LAST_DAY(ADD_MONTHS(sysdate,-1))-6 and LAST_DAY(ADD_MONTHS(sysdate,-1))
    and a12.RGNCD in ('54')
-- 공결대상상품은 아래에 입력해주세요 1st
    and a11.GOODCD in ('8809744101019', '8809184807724', '8808024030872', '8808024030919', '8808024030896', '8809046593680', '8809804990218', '8801104123280', '8801062623471', '8801056094591', '8801037087543', '8801037087550', '8801056018900', '8801056018948', '8801056032159', '8801094577100', '8801037035476', '8801037040029', '8801056018979', '8801094503000', '8801094513009', '8801007171210', '8801382124849', '8806002006437', '8806011615408', '8806016310018', '8801097250079', '8801056190019', '8801094012403', '8801056192013', '8801056193010', '8801056755010', '8801094017606', '8801043450690', '8801056143015', '8801094013004', '8808244201014', '8809482500488', '8801056055202', '8801056831011', '8801105911299', '8801105915006', '8801858133337', '8801119740113', '8801858011024', '3080216031811', '6901035603232', '8712000900045', '8801048951017', '8801030995470', '8801019306907', '8801117431907', '8801117446901', '4001686301555', '4001686375754', '5012035901738', '8801019005909', '8410031990973', '8801062331673', '8801019204951', '8801062628476', '8801062636884', '8801007022635', '8801043016070', '8809296882831', '8801043015639', '8801043015653', '8801043015714', '8801043014809', '8801043014984', '8801043015226', '8801045520124', '8801007310572', '8801047161608', '8801037055542', '8801037085594', '8801013770087', '8803651000045', '8809190084843'))
    group by	a11.STORECD,
        a11.GOODCD
    having  sum( case when a11.stk_qty > 0 then 1
            else 0 END) >0
), ShortageProd AS(
    select	a11.STORECD  STORECD,
        a11.GOODCD  GOODCD,
        sum( case when a11.stk_qty < 1 then 1
            else 0 END) AS 미취급

    from	LGMJVDP.TB_STK_FT	a11
        join	LGMJVDP.TB_STORE_DM	a12
        on 	(a11.STORECD = a12.STORECD)

    where	(a11.DATECD between TRUNC(SYSDATE, 'MM') and to_char(sysdate-2, 'YYYY-MM-DD')
    and a12.RGNCD in ('54')
-- 공결대상상품은 아래에 입력해주세요 2st
    and a11.GOODCD in ('8809744101019', '8809184807724', '8808024030872', '8808024030919', '8808024030896', '8809046593680', '8809804990218', '8801104123280', '8801062623471', '8801056094591', '8801037087543', '8801037087550', '8801056018900', '8801056018948', '8801056032159', '8801094577100', '8801037035476', '8801037040029', '8801056018979', '8801094503000', '8801094513009', '8801007171210', '8801382124849', '8806002006437', '8806011615408', '8806016310018', '8801097250079', '8801056190019', '8801094012403', '8801056192013', '8801056193010', '8801056755010', '8801094017606', '8801043450690', '8801056143015', '8801094013004', '8808244201014', '8809482500488', '8801056055202', '8801056831011', '8801105911299', '8801105915006', '8801858133337', '8801119740113', '8801858011024', '3080216031811', '6901035603232', '8712000900045', '8801048951017', '8801030995470', '8801019306907', '8801117431907', '8801117446901', '4001686301555', '4001686375754', '5012035901738', '8801019005909', '8410031990973', '8801062331673', '8801019204951', '8801062628476', '8801062636884', '8801007022635', '8801043016070', '8809296882831', '8801043015639', '8801043015653', '8801043015714', '8801043014809', '8801043014984', '8801043015226', '8801045520124', '8801007310572', '8801047161608', '8801037055542', '8801037085594', '8801013770087', '8803651000045', '8809190084843'))
    group by	a11.STORECD,
        a11.GOODCD
    having sum( case when a11.stk_qty < 1 then 1
            else 0 END) > 0
), OPEN_DT AS(
    select	a11.STORECD  STORECD,
	    sum(a11.SALDT_CNT) AS 영업일수
    from	LGMJVDP.TB_SALDT_FT	a11
        join	LGMJVDP.TB_STORE_DM	a12
        on 	(a11.STORECD = a12.STORECD)
    where	a11.DATECD between TRUNC(SYSDATE, 'MM') and to_char(sysdate-2, 'YYYY-MM-DD')
        and a12.RGNCD in ('54')
    group by	a11.STORECD
)

select a1.STORECD,
sum(a2.미취급) AS 미취급,
(select count(b1.GOODCD) from UseProd b1 where STORECD = a1.STORECD) AS 취급대상,
max(a3.영업일수) 영업일수,
round(sum(a2.미취급) / ((select count(b1.GOODCD) from UseProd b1 where STORECD = a1.STORECD) * max(a3.영업일수))*100,2) AS 취급률

from UseProd a1
inner join ShortageProd a2
    on (a1.STORECD = a2.STORECD)
    and (a1.GOODCD = a2.GOODCD)
inner join OPEN_DT a3
    on (a1.STORECD = a3.STORECD)
--WHERE a1.STORECD in ('4D89')
GROUP BY a1.STORECD
