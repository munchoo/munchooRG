 -- 대상상품 추출
-- UserProd 는 전월 말일 7일전 부터 재고가 0개 이상인 것에 대한 취급여부 판단.
-- ShortageProd 는 해당기간의 취급 상품을 전체 표시 (당월)
-- with문으로 조회 후 inner 조인으로 UserProd와 ShortageProd를 묶음.(대상상품만 추출하기위해)
-- 영업일수를 가져와서 조인하고 마지막에 취급률을 계산 (누적결품상품수 / (결품대상상품수 * 영업일수)*100)
WITH UseProd AS (
    select    a11.STORECD  STORECD,
        a11.GOODCD  GOODCD,
        max(trim(trailing from a13.GOODNM))  GOODNM,
        sum( case when a11.stk_qty > 0 then 1
            else 0 END) AS 취급
    from    LGMJVDP.TB_STK_FT    a11
        join    LGMJVDP.TB_STORE_DM    a12
        on     (a11.STORECD = a12.STORECD)
        join    LGMJVDP.TB_GOOD_DM    a13
        on     (a11.GOODCD = a13.GOODCD)
    where    (a11.DATECD between LAST_DAY(ADD_MONTHS(sysdate,-1))-7 and LAST_DAY(ADD_MONTHS(sysdate,-1))
    and a12.RGNCD in ('54')
-- 공결대상상품은 아래에 입력해주세요 1st
    and a11.GOODCD in ('8801104123280', '8801062623471', '8801056094591', '8801037086195', '8801037087543', '8801037087550', '8801056018900', '8801056018948', '8801037035476', '8801037039993', '8801037040029', '8801037042863', '8801056018979', '8801056050269', '8801094503000', '8801094513009', '8801001238049', '8801007171210', '8801382124849', '8806002006437', '8801007071046', '8806002001845', '8801056038861', '8806011615408', '8806016310018', '8801094362706', '8801094412005', '8801097250079', '8801056190019', '8801094012403', '8801094112707', '8801043450690', '8801056143015', '8801056610012', '8801094013004', '8801097160064', '8808244201014', '8809482500488', '8801056055202', '8801382127710', '8801382148326', '8801056831011', '8801105911299', '8801105915006', '8801858133337', '8801119740113', '8801858011024', '3080216031811', '8712000900045', '8801048951017', '8801030995470', '8801019306495', '8801019606540', '8801111611312', '8801117760106', '8801019306907', '8801062634415', '8801062870462', '8801117276201', '8801117431907', '8801117446901', '8801037088168', '8801117534912', '4001686301555', '4001686375754', '5012035901738', '8801019005909', '6924513900098', '8410031990973', '8804973304835', '8801062318551', '8801062323159', '8801019204951', '8801062628476', '8801007022635', '8801043015967', '8801043015981', '8801043016070', '8801045570419', '8801073210363', '8801128503211', '8809296882831', '8801043015639', '8801043015653', '8801043015714', '8801043014809', '8801043014984', '8801043015226', '8801045520124', '8801007310572', '8801037006391', '8801037085594', '8801013770087', '8803651000045', '8809190084843', '8801308448578', '8801308448585', '8888021305470', '8888021305463', '8809121477935', '8808024030933', '8809046593666', '8808024030957', '8809184807700', '8801223011994', '8801223011987', '8801019611186', '8801062866052', '8801045479910', '8801045628400'))
    group by    a11.STORECD,
        a11.GOODCD
    having  sum( case when a11.stk_qty > 0 then 1 else 0 END) >0
), ShortageProd AS(
    select    a11.STORECD  STORECD,
        a11.GOODCD  GOODCD,
        sum( case when a11.stk_qty < 1 then 1
            else 0 END) AS 결품상품수

    from    LGMJVDP.TB_STK_FT    a11
        join    LGMJVDP.TB_STORE_DM    a12
        on     (a11.STORECD = a12.STORECD)
    where    (a11.DATECD between TRUNC(SYSDATE, 'MM') and to_char(sysdate-2, 'YYYY-MM-DD')
    and a12.RGNCD in ('54')
-- 공결대상상품은 아래에 입력해주세요 2st
    and a11.GOODCD in ('8801104123280', '8801062623471', '8801056094591', '8801037086195', '8801037087543', '8801037087550', '8801056018900', '8801056018948', '8801037035476', '8801037039993', '8801037040029', '8801037042863', '8801056018979', '8801056050269', '8801094503000', '8801094513009', '8801001238049', '8801007171210', '8801382124849', '8806002006437', '8801007071046', '8806002001845', '8801056038861', '8806011615408', '8806016310018', '8801094362706', '8801094412005', '8801097250079', '8801056190019', '8801094012403', '8801094112707', '8801043450690', '8801056143015', '8801056610012', '8801094013004', '8801097160064', '8808244201014', '8809482500488', '8801056055202', '8801382127710', '8801382148326', '8801056831011', '8801105911299', '8801105915006', '8801858133337', '8801119740113', '8801858011024', '3080216031811', '8712000900045', '8801048951017', '8801030995470', '8801019306495', '8801019606540', '8801111611312', '8801117760106', '8801019306907', '8801062634415', '8801062870462', '8801117276201', '8801117431907', '8801117446901', '8801037088168', '8801117534912', '4001686301555', '4001686375754', '5012035901738', '8801019005909', '6924513900098', '8410031990973', '8804973304835', '8801062318551', '8801062323159', '8801019204951', '8801062628476', '8801007022635', '8801043015967', '8801043015981', '8801043016070', '8801045570419', '8801073210363', '8801128503211', '8809296882831', '8801043015639', '8801043015653', '8801043015714', '8801043014809', '8801043014984', '8801043015226', '8801045520124', '8801007310572', '8801037006391', '8801037085594', '8801013770087', '8803651000045', '8809190084843', '8801308448578', '8801308448585', '8888021305470', '8888021305463', '8809121477935', '8808024030933', '8809046593666', '8808024030957', '8809184807700', '8801223011994', '8801223011987', '8801019611186', '8801062866052', '8801045479910', '8801045628400'))
    group by    a11.STORECD,
        a11.GOODCD
    having sum( case when a11.stk_qty < 1 then 1
            else 0 END) > 0
), OPEN_DT AS(
    select    a11.STORECD  STORECD,
        sum(a11.SALDT_CNT) AS 영업일수
    from    LGMJVDP.TB_SALDT_FT    a11
        join    LGMJVDP.TB_STORE_DM    a12
        on     (a11.STORECD = a12.STORECD)
    where    a11.DATECD between TRUNC(SYSDATE, 'MM') and to_char(sysdate-2, 'YYYY-MM-DD')
        and a12.RGNCD in ('54')
    group by    a11.STORECD
    having sum(a11.SALDT_CNT) > 0
)

select a1.STORECD,
sum(a2.결품상품수)  AS 결품상품수,
(select count(b1.GOODCD) from UseProd b1 where STORECD = a1.STORECD) AS 취급대상,
max(a3.영업일수) 영업일수,
round((sum(a2.결품상품수)/((select count(b1.GOODCD) from UseProd b1 where STORECD = a1.STORECD)*max(a3.영업일수)))*100,2) AS 취급률

from UseProd a1
left join ShortageProd a2
    on (a1.STORECD = a2.STORECD)
    and (a1.GOODCD = a2.GOODCD)
left join OPEN_DT a3
    on (a1.STORECD = a3.STORECD)
where a1.STORECD in ('S355')
GROUP BY a1.STORECD

----------//////////////////// 여기부터는 결품상품을 가져오는 쿼리입니다. 


WITH ItemRef AS (
    select 
        a12.STORECD,
        a11.GOODCD,
        a11.GOODNM
    from LGMJVDP.TB_GOOD_DM a11
    cross join LGMJVDP.TB_STORE_DM a12
    where a11.GOODCD in ('8801104123280', '8801062623471', '8801056094591', '8801037086195', '8801037087543', '8801037087550', '8801056018900', '8801056018948', '8801037035476', '8801037039993', '8801037040029', '8801037042863', '8801056018979', '8801056050269', '8801094503000', '8801094513009', '8801001238049', '8801007171210', '8801382124849', '8806002006437', '8801007071046', '8806002001845', '8801056038861', '8806011615408', '8806016310018', '8801094362706', '8801094412005', '8801097250079', '8801056190019', '8801094012403', '8801094112707', '8801043450690', '8801056143015', '8801056610012', '8801094013004', '8801097160064', '8808244201014', '8809482500488', '8801056055202', '8801382127710', '8801382148326', '8801056831011', '8801105911299', '8801105915006', '8801858133337', '8801119740113', '8801858011024', '3080216031811', '8712000900045', '8801048951017', '8801030995470', '8801019306495', '8801019606540', '8801111611312', '8801117760106', '8801019306907', '8801062634415', '8801062870462', '8801117276201', '8801117431907', '8801117446901', '8801037088168', '8801117534912', '4001686301555', '4001686375754', '5012035901738', '8801019005909', '6924513900098', '8410031990973', '8804973304835', '8801062318551', '8801062323159', '8801019204951', '8801062628476', '8801007022635', '8801043015967', '8801043015981', '8801043016070', '8801045570419', '8801073210363', '8801128503211', '8809296882831', '8801043015639', '8801043015653', '8801043015714', '8801043014809', '8801043014984', '8801043015226', '8801045520124', '8801007310572', '8801037006391', '8801037085594', '8801013770087', '8803651000045', '8809190084843', '8801308448578', '8801308448585', '8888021305470', '8888021305463', '8809121477935', '8808024030933', '8809046593666', '8808024030957', '8809184807700', '8801223011994', '8801223011987', '8801019611186', '8801062866052', '8801045479910', '8801045628400')


    and a12.RGNCD in ('54')
), prod AS (
    select
    distinct(GOODCD) GOODCD
    from ItemRef
), UnUseProd AS (
    select    a11.STORECD  STORECD,
        a11.GOODCD  GOODCD
    from    LGMJVDP.TB_STK_FT    a11
        join    LGMJVDP.TB_STORE_DM    a12
        on     (a11.STORECD = a12.STORECD)
        join    LGMJVDP.TB_GOOD_DM    a13
        on     (a11.GOODCD = a13.GOODCD)
    where    (a11.DATECD between LAST_DAY(ADD_MONTHS(sysdate,-1))-7 and LAST_DAY(ADD_MONTHS(sysdate,-1))
    and a12.RGNCD in ('54')
-- 공결대상상품은 아래에 입력해주세요 1st
    and a11.GOODCD in ('8801104123280', '8801062623471', '8801056094591', '8801037086195', '8801037087543', '8801037087550', '8801056018900', '8801056018948', '8801037035476', '8801037039993', '8801037040029', '8801037042863', '8801056018979', '8801056050269', '8801094503000', '8801094513009', '8801001238049', '8801007171210', '8801382124849', '8806002006437', '8801007071046', '8806002001845', '8801056038861', '8806011615408', '8806016310018', '8801094362706', '8801094412005', '8801097250079', '8801056190019', '8801094012403', '8801094112707', '8801043450690', '8801056143015', '8801056610012', '8801094013004', '8801097160064', '8808244201014', '8809482500488', '8801056055202', '8801382127710', '8801382148326', '8801056831011', '8801105911299', '8801105915006', '8801858133337', '8801119740113', '8801858011024', '3080216031811', '8712000900045', '8801048951017', '8801030995470', '8801019306495', '8801019606540', '8801111611312', '8801117760106', '8801019306907', '8801062634415', '8801062870462', '8801117276201', '8801117431907', '8801117446901', '8801037088168', '8801117534912', '4001686301555', '4001686375754', '5012035901738', '8801019005909', '6924513900098', '8410031990973', '8804973304835', '8801062318551', '8801062323159', '8801019204951', '8801062628476', '8801007022635', '8801043015967', '8801043015981', '8801043016070', '8801045570419', '8801073210363', '8801128503211', '8809296882831', '8801043015639', '8801043015653', '8801043015714', '8801043014809', '8801043014984', '8801043015226', '8801045520124', '8801007310572', '8801037006391', '8801037085594', '8801013770087', '8803651000045', '8809190084843', '8801308448578', '8801308448585', '8888021305470', '8888021305463', '8809121477935', '8808024030933', '8809046593666', '8808024030957', '8809184807700', '8801223011994', '8801223011987', '8801019611186', '8801062866052', '8801045479910', '8801045628400')
    and a11.stk_qty > 0)

    group by    a11.STORECD,
        a11.GOODCD
--    having  sum( case when a11.stk_qty > 0 then 1 else 0 END) >0
), Header AS(
    select
    a11.STORECD,
    a11.GOODCD,
    a11.GOODNM
    from ItemRef a11
    left join UnUseProd a12wr
    on a11.STORECD = a12.STORECD
    and a11.GOODCD = a12.GOODCD
    where a12.STORECD is null
    and a12.GOODCD is null
), Body AS(
    select a11.STORECD,
    a11.GOODCD,
    case when sum(a11.stk_qty) > 0 then 1 else 0 end AS 발주수량
    from LGMJVDP.TB_STK_FT a11
    join LGMJVDP.TB_STORE_DM a12
    on a11.STORECD = a12.STORECD
    and a12.RGNCD in ('54')
    where a11.DATECD between TRUNC(SYSDATE, 'MM') and to_char(sysdate-2, 'YYYY-MM-DD')
    and a11.GOODCD in (select GOODCD from prod)
    group by a11.DATECD, a11.STORECD, a11.GOODCD
)
   select
        a11.STORECD,
        a11.GOODCD,
        a11.GOODNM,
        CASE when sum(a13.발주수량) > 0 then 1 else 0 end AS 발주여부       
    from Header a11
    left join prod a12
        on a11.GOODCD = a12.GOODCD
    left join Body a13
        on a11.STORECD = a13.STORECD
        and a12.GOODCD = a13.GOODCD
    left join LGMJVDP.TB_STORE_DM a14
        on a11.STORECD = a14.STORECD
    group by a11.GOODCD, a11.STORECD, a11.GOODNM
