-- gopa1 매입수량과 판맷수량 매입원가 판매원가를 구하는 테이블
-- gopa2 는 해당기간 d-1의 재고를 가져온다
-- 마지막 select문으로 gopa1, gopa2를 풀조인해서 합친다.


with	 gopa1 as
 		(select	a11.GOODCD GOODCD,
		 	a11.STORECD STORECD,
			sum(a11.IN_QTY)  WJXBFS1,
			sum(a11.SAL_QTY)  WJXBFS2,
			sum(a11.IN_AMT) WJXBFS3,
        	sum(a11.NTSAL_CAMT) WJXBFS4
		from	LGMJVDP.TB_STK_FT	a11
			join LGMJVDP.TB_STORE_DM a13
			  on (a11.STORECD = a13.STORECD)
		where	(a11.GOODCD in ('8801062012701', '8801062012725', '8801062883646', '8801062012756', '8801062012732', '8801062870806', '8801062874378', '8801062870820', '8801019314001', '8801019309946', '8801019311345', '8801019310928', '8801019314872', '8801019314803', '8801019314797', '8009280006766', '8009280006759', '810253010837', '8803420903188', '8809827250207', '8801062871315', '8801062871308', '8801062871285', '8801062871292', '8801062871278', '8801062871254', '8801062871261', '8801062871247', '8801062871230', '8801062871223', '8801062869374', '8801062869381', '8801062869428', '8801062869411', '8801062869404', '8801062869398', '8809344669292', '8809344669308', '8809344669315', '8809344669322', '8809344669339', '8809344669346', '8809344669360', '8809344669377', '8809344669384', '8809344669391', '8809344669407', '8809344669285', '8809344669414', '8809344669421', '8809649054557', '8809649054564', '8809649054571', '8809649054588', '8809649054601', '8809649054618', '8809649054625', '8809649054595', '8803747117435', '8803747117305', '8803747117244', '8803747117329', '8803747117336', '8803747117343', '8803747117350', '8803747117367', '8803747117374', '8803747117237', '8809318026618', '8809318026625', '8809318026632', '8809318026649', '8809415435283', '8809406955134', '8809406955318', '8809406955325', '8809406955158', '8803747117381', '8809406955172', '8809406955301', '8809406955240', '8809406955196', '8809406955202', '8809406955264', '8809406955271', '8809406955288', '8803747117473', '8803747117480', '8803747117497', '8803747117503', '8803747117510', '8809649054465', '8809649054458', '8803747117442', '8803747117459', '8803747117466', '8803747117275', '8803747117282', '8803747117428', '8809649054410', '8809649055011', '8809649054632', '8809649054403', '8809649054441', '8809649054649', '8809649054397', '8809318026588', '8809318026731', '8809318026748', '8809318026755', '8809318026687', '8809318026694', '8809318026656', '8809318026670', '8809290406880', '8809290406934', '8803747117404', '8803747117398', '8803747117411', '8803747117527', '8803747117312', '8809318026519', '8809318026526', '8809318026533', '8809318026540', '8809318026557', '80050278', '80135906', '8000500005026', '8000500133170', '8000500003787', '80050513', '8000500187166', '8000500331750', '8000500009673', '8000500178638', '8000500227671', '8000500180723')
		 and a11.DATECD in ('2021-11-14')
		 and a13.RGNCD in ('30'))
		group by	a11.STORECD,
					a11.GOODCD
		), 
	 gopa2 as
 		(select	a11.GOODCD GOODCD,
		 	a11.STORECD STORECD,
			sum(a11.stk_qty)  WJXBFS1,
			sum(a11.stk_amt) WJXBFS2
		from	LGMJVDP.TB_STK_FT	a11
			join	LGMJVDP.TB_DATE_DM	a12
			  on (a11.DATECD = a12.DATECD  -1 day)
			join LGMJVDP.TB_STORE_DM a13
			  on (a11.STORECD = a13.STORECD)
		where	(a11.GOODCD in ('8801062012701', '8801062012725', '8801062883646', '8801062012756', '8801062012732', '8801062870806', '8801062874378', '8801062870820', '8801019314001', '8801019309946', '8801019311345', '8801019310928', '8801019314872', '8801019314803', '8801019314797', '8009280006766', '8009280006759', '810253010837', '8803420903188', '8809827250207', '8801062871315', '8801062871308', '8801062871285', '8801062871292', '8801062871278', '8801062871254', '8801062871261', '8801062871247', '8801062871230', '8801062871223', '8801062869374', '8801062869381', '8801062869428', '8801062869411', '8801062869404', '8801062869398', '8809344669292', '8809344669308', '8809344669315', '8809344669322', '8809344669339', '8809344669346', '8809344669360', '8809344669377', '8809344669384', '8809344669391', '8809344669407', '8809344669285', '8809344669414', '8809344669421', '8809649054557', '8809649054564', '8809649054571', '8809649054588', '8809649054601', '8809649054618', '8809649054625', '8809649054595', '8803747117435', '8803747117305', '8803747117244', '8803747117329', '8803747117336', '8803747117343', '8803747117350', '8803747117367', '8803747117374', '8803747117237', '8809318026618', '8809318026625', '8809318026632', '8809318026649', '8809415435283', '8809406955134', '8809406955318', '8809406955325', '8809406955158', '8803747117381', '8809406955172', '8809406955301', '8809406955240', '8809406955196', '8809406955202', '8809406955264', '8809406955271', '8809406955288', '8803747117473', '8803747117480', '8803747117497', '8803747117503', '8803747117510', '8809649054465', '8809649054458', '8803747117442', '8803747117459', '8803747117466', '8803747117275', '8803747117282', '8803747117428', '8809649054410', '8809649055011', '8809649054632', '8809649054403', '8809649054441', '8809649054649', '8809649054397', '8809318026588', '8809318026731', '8809318026748', '8809318026755', '8809318026687', '8809318026694', '8809318026656', '8809318026670', '8809290406880', '8809290406934', '8803747117404', '8803747117398', '8803747117411', '8803747117527', '8803747117312', '8809318026519', '8809318026526', '8809318026533', '8809318026540', '8809318026557', '80050278', '80135906', '8000500005026', '8000500133170', '8000500003787', '80050513', '8000500187166', '8000500331750', '8000500009673', '8000500178638', '8000500227671', '8000500180723')
		 and a12.DATECD in ('2021-11-14')
		 and a13.RGNCD in ('30'))
		group by	a11.STORECD,
					a11.GOODCD
		),



		-- 기간 총매출 가져오기
		gopa3 as  (select	a11.STORECD  STORECD,
				a11.GOODCD  GOODCD,
				sum(a11.SAL_QTY) + abs(sum(a11.BUY_QTY))  WJXBFS11,
				sum(a11.NTSAL_CAMT) WJXBFS12
			from	LGMJVDP.TB_STK_FT	a11
				join	LGMJVDP.TB_STORE_DM	a12
				on 	(a11.STORECD = a12.STORECD)
			where	(a12.RGNCD in ('30')
			and a11.GOODCD in ('8801062012701', '8801062012725', '8801062883646', '8801062012756', '8801062012732', '8801062870806', '8801062874378', '8801062870820', '8801019314001', '8801019309946', '8801019311345', '8801019310928', '8801019314872', '8801019314803', '8801019314797', '8009280006766', '8009280006759', '810253010837', '8803420903188', '8809827250207', '8801062871315', '8801062871308', '8801062871285', '8801062871292', '8801062871278', '8801062871254', '8801062871261', '8801062871247', '8801062871230', '8801062871223', '8801062869374', '8801062869381', '8801062869428', '8801062869411', '8801062869404', '8801062869398', '8809344669292', '8809344669308', '8809344669315', '8809344669322', '8809344669339', '8809344669346', '8809344669360', '8809344669377', '8809344669384', '8809344669391', '8809344669407', '8809344669285', '8809344669414', '8809344669421', '8809649054557', '8809649054564', '8809649054571', '8809649054588', '8809649054601', '8809649054618', '8809649054625', '8809649054595', '8803747117435', '8803747117305', '8803747117244', '8803747117329', '8803747117336', '8803747117343', '8803747117350', '8803747117367', '8803747117374', '8803747117237', '8809318026618', '8809318026625', '8809318026632', '8809318026649', '8809415435283', '8809406955134', '8809406955318', '8809406955325', '8809406955158', '8803747117381', '8809406955172', '8809406955301', '8809406955240', '8809406955196', '8809406955202', '8809406955264', '8809406955271', '8809406955288', '8803747117473', '8803747117480', '8803747117497', '8803747117503', '8803747117510', '8809649054465', '8809649054458', '8803747117442', '8803747117459', '8803747117466', '8803747117275', '8803747117282', '8803747117428', '8809649054410', '8809649055011', '8809649054632', '8809649054403', '8809649054441', '8809649054649', '8809649054397', '8809318026588', '8809318026731', '8809318026748', '8809318026755', '8809318026687', '8809318026694', '8809318026656', '8809318026670', '8809290406880', '8809290406934', '8803747117404', '8803747117398', '8803747117411', '8803747117527', '8803747117312', '8809318026519', '8809318026526', '8809318026533', '8809318026540', '8809318026557', '80050278', '80135906', '8000500005026', '8000500133170', '8000500003787', '80050513', '8000500187166', '8000500331750', '8000500009673', '8000500178638', '8000500227671', '8000500180723')
			and a11.DATECD BETWEEN ('2021-11-01') and ('2021-11-16'))
			group by	a11.STORECD,
				a11.GOODCD
			),

		-- 기초재고가져오기
		gopa4 as  (select	a11.STORECD  STORECD,
				a11.GOODCD  GOODCD,
				sum(a11.stk_qty)  WJXBFS21,
				sum(a11.stk_amt) WJXBFS22
			from	LGMJVDP.TB_STK_FT	a11
				join	LGMJVDP.TB_STORE_DM	a12
				on 	(a11.STORECD = a12.STORECD)
			where	(a12.RGNCD in ('30')
			and a11.GOODCD in ('8801062012701', '8801062012725', '8801062883646', '8801062012756', '8801062012732', '8801062870806', '8801062874378', '8801062870820', '8801019314001', '8801019309946', '8801019311345', '8801019310928', '8801019314872', '8801019314803', '8801019314797', '8009280006766', '8009280006759', '810253010837', '8803420903188', '8809827250207', '8801062871315', '8801062871308', '8801062871285', '8801062871292', '8801062871278', '8801062871254', '8801062871261', '8801062871247', '8801062871230', '8801062871223', '8801062869374', '8801062869381', '8801062869428', '8801062869411', '8801062869404', '8801062869398', '8809344669292', '8809344669308', '8809344669315', '8809344669322', '8809344669339', '8809344669346', '8809344669360', '8809344669377', '8809344669384', '8809344669391', '8809344669407', '8809344669285', '8809344669414', '8809344669421', '8809649054557', '8809649054564', '8809649054571', '8809649054588', '8809649054601', '8809649054618', '8809649054625', '8809649054595', '8803747117435', '8803747117305', '8803747117244', '8803747117329', '8803747117336', '8803747117343', '8803747117350', '8803747117367', '8803747117374', '8803747117237', '8809318026618', '8809318026625', '8809318026632', '8809318026649', '8809415435283', '8809406955134', '8809406955318', '8809406955325', '8809406955158', '8803747117381', '8809406955172', '8809406955301', '8809406955240', '8809406955196', '8809406955202', '8809406955264', '8809406955271', '8809406955288', '8803747117473', '8803747117480', '8803747117497', '8803747117503', '8803747117510', '8809649054465', '8809649054458', '8803747117442', '8803747117459', '8803747117466', '8803747117275', '8803747117282', '8803747117428', '8809649054410', '8809649055011', '8809649054632', '8809649054403', '8809649054441', '8809649054649', '8809649054397', '8809318026588', '8809318026731', '8809318026748', '8809318026755', '8809318026687', '8809318026694', '8809318026656', '8809318026670', '8809290406880', '8809290406934', '8803747117404', '8803747117398', '8803747117411', '8803747117527', '8803747117312', '8809318026519', '8809318026526', '8809318026533', '8809318026540', '8809318026557', '80050278', '80135906', '8000500005026', '8000500133170', '8000500003787', '80050513', '8000500187166', '8000500331750', '8000500009673', '8000500178638', '8000500227671', '8000500180723')
			and a11.DATECD in ('2021-11-01'))
			group by	a11.STORECD,
				a11.GOODCD
			)

		 select
		 	coalesce(pa11.STORECD, pa12.STORECD, pa13.STORECD, pa14.STORECD)  STORECD,
			coalesce(pa11.GOODCD, pa12.GOODCD, pa13.GOODCD, pa14.GOODCD)  GOODCD,
			a14.GOODNM,
			((VALUE(pa11.WJXBFS1, 0) + VALUE(pa12.WJXBFS1, 0)) - VALUE(pa11.WJXBFS2, 0)) 재고수량,
			((VALUE(pa11.WJXBFS3, 0) + VALUE(pa12.WJXBFS2, 0)) - VALUE(pa11.WJXBFS4, 0))  재고원가,
			(VALUE(pa13.WJXBFS11, 0)) 판매수량,
			(VALUE(pa13.WJXBFS12, 0)) 판매원가,
			(VALUE(pa14.WJXBFS21, 0)) 기초재고수량,
			(VALUE(pa14.WJXBFS22, 0)) 기초재고원가
			-- count(*)
	from	gopa1	pa11
		full outer join	gopa2	pa12
			on pa11.STORECD = pa12.STORECD
			and pa11.GOODCD = pa12.GOODCD
		full outer join gopa3 pa13
			on pa11.STORECD = pa13.STORECD
			and pa11.GOODCD = pa13.GOODCD
		full outer join gopa4 pa14
			on pa11.STORECD = pa14.STORECD
			and pa11.GOODCD = pa14.GOODCD
		join	LGMJVDP.TB_GOOD_DM	a14
	 		on coalesce(pa11.GOODCD, pa12.GOODCD, pa13.GOODCD, pa14.GOODCD) = a14.GOODCD
	-- group by
	-- 		coalesce(pa11.STORECD, pa12.STORECD)  STORECD,
	-- 		coalesce(pa11.GOODCD, pa12.GOODCD)  GOODCD,
	-- 		-- a14.GOODNM GOODNM


